<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Demo for affiliates to access Binary.com charts in IFRAME</title>
    <script src="../lib/jquery/dist/jquery.min.js"></script>
    <script src="../lib/reconnectingWebsocket/reconnecting-websocket.min.js"></script>
</head>
<body>
    <table width="600px" align="center">
        <tr>
            <td align="right" width="25%">Instruments : </td>
            <td align="left" width="25%">
                <select id="instruments">
                </select>
            </td>
            <td align="right" width="25%">Time period : </td>
            <td align="left" width="25%">
                <select id="timePeriod">
                    <option value="1m">1m</option>
                    <option value="5m">5m</option>
                    <option value="15m">15m</option>
                    <option value="1h">1h</option>
                    <option value="4h">4h</option>
                    <option value="1d">1d</option>
                </select>
            </td>
        </tr>
        <tr align="center">
            <td colspan="4">
                <iframe src="" width="100%" height="520" id="chartFrame" style="overflow-y : hidden;" scrolling='no'></iframe>
            </td>
        </tr>
    </table>
    <script charset="utf-8">
    $(document).ready(function() {
        var ws = new ReconnectingWebSocket("wss://www.binary.com/websockets/v2");
        ws.debug = false;
        ws.timeoutInterval = 5400;
        ws.onopen = function(event) {
            var now = new Date();
            var requestData = { 
              "trading_times": now.getFullYear() + "-" + now.getMonth() + "-" + now.getDate()
            };
            console.log('request data', requestData);
            
            $("#instruments").append("<option value='0'>Loading instruments...</option>");

            ws.send(JSON.stringify(requestData));
        };
        ws.onmessage = function(event) {
            var data = JSON.parse(event.data);
            console.log('message received', data);
            switch (data.msg_type) {
                case "trading_times":
                    $("#instruments").html('');
                    for (var marketIndex in data.trading_times.markets) {
                        var marketFromResponse = data.trading_times.markets[marketIndex];
                        for (var submarketIndxx in marketFromResponse.submarkets) {
                            var submarket = marketFromResponse.submarkets[submarketIndxx];
                            for (var eachSymbolIndx in submarket.symbols) {
                                var eachSymbol = submarket.symbols[eachSymbolIndx];
                                $("<option>").append(eachSymbol.name)
                                    .attr('value', eachSymbol.symbol)
                                    .appendTo($('#instruments'));
                            }
                        }
                    }
                    $('#instruments').val('R_25').change();
                    ws.close();
                    break;
            }
        }

        /*
          Attaching change event to the drop downs
        */
        $("#instruments, #timePeriod").change(function() {
            var instrumentCode = $("#instruments").val();
            var timePeriod = $("#timePeriod").val();
            console.log('changed', instrumentCode + ' : ' + timePeriod);
            if (instrumentCode && timePeriod) {
                $("#chartFrame").attr('src', '/index.html?affiliates=true&instrument=' + instrumentCode + '&timePeriod=' + timePeriod);
            }
        });

    });
    </script>
</body>
</html>
