define(["exports","jquery","windows/windows","websockets/binary_websockets","charts/chartingRequestMap","common/rivetsExtra","moment","trade/lookback","common/util"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){return a&&a.__esModule?a:{"default":a}}function j(a,b){G(a,b);var c=b.chart.chart;c&&(k(a,b,c),M(a,b))}function k(a,b,c){function d(a){var b="Entry Spot".i18n();a&&!h(b)&&c.addPlotLineX({value:1e3*a,label:b})}function e(a,b){var d="Exit Spot".i18n();a&&!h(d)&&c.addPlotLineX({value:1e3*+a,label:d,text_left:b,dashStyle:"Dash"})}function f(a){var b="End Time".i18n();return!a||h(b)?!1:void c.addPlotLineX({value:1e3*a,label:b,dashStyle:"Dash"})}function g(a,b){var d="Start Time".i18n();a&&!h(d)&&c.addPlotLineX({value:1e3*a,label:d,text_left:b})}function h(a){return b.chart.added_labels.includes(a)?!0:(b.chart.added_labels.push(a),!1)}var i=a.entry_tick_time,j=a.exit_tick_time,k=a.date_expiry,l=a.date_start,m=!0;d(i),g(l,m),e(j,m),f(k)}function l(a,b){function c(b){var c=+b.proposal_open_contract.contract_id!==+a.proposal_open_contract.contract_id;if(!c)return b.error?void C(b.error.message):void D(b,a)}K=c,o["default"].proposal_open_contract.subscribe(b.contract_id),o["default"].events.on("proposal_open_contract",K)}Object.defineProperty(a,"__esModule",{value:!0}),a.init=void 0;var m=i(b),n=i(c),o=i(d),p=i(e),q=i(f),r=i(g),s=i(h),t=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a},u=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),v={},w=3,x={EXPIRED:"This contract has expired".i18n(),MARKET_RATE:"Note: Contract will be sold at the prevailing market price when the request is received by our servers. This price may differ from the indicated price.".i18n(),NO_RESALE:"Resale of this contract is not offered".i18n(),FINISHED:"This contract has expired".i18n()};require(["css!viewtransaction/viewTransaction.css"]),require(["text!viewtransaction/viewTransaction.html"]);var y=null,z=function(){if(y)return void y.moveToTop();var a="There was a market data disruption during the contract period. For real-money accounts we will attempt to correct this and settle the contract properly, otherwise the contract will be cancelled and refunded. Virtual-money contracts will be cancelled and refunded.".i18n(),b=m["default"]('<div class="data-disruption-dialog">'+a+"</div>");y=n["default"].createBlankWindow(b,{title:" There was an error ".i18n(),height:200,resizable:!1,collapsable:!1,minimizable:!1,maximizable:!1,destroy:function(){y&&y.dialog("destroy").remove(),y=null},"data-authorized":"true"}),y.dialog("open"),window.dd=y},A=function(a,b,c){var d=[],e="",f=0;if(c.history){e="line";for(var g=c.history,h=g.times,i=g.prices,j=0;j<h.length;++j)d.push([1e3*h[j],1*i[j]]),f=Math.max(f,i[j].substring(i[j].indexOf(".")+1).length)}c.candles&&(e="candlestick",d=c.candles.map(function(a){return[1e3*a.epoch,1*a.open,1*a.high,1*a.low,1*a.close]}));var k=c.title,l=a.find(".transaction-chart")[0],m={credits:{href:"#",text:""},chart:{type:"line",renderTo:l,backgroundColor:null,width:0,height:0,marginLeft:20,marginRight:20},title:{text:""},tooltip:{xDateFormat:"%A, %b %e, %H:%M:%S GMT",valueDecimals:f||void 0},xAxis:{type:"datetime",categories:null,startOnTick:!1,endOnTick:!1,min:d.length?d[0][0]:null,max:d.length?d[d.length-1][0]:null,labels:{overflow:"justify",format:"{value:%H:%M:%S}"}},yAxis:{labels:{align:"left",x:0,y:-2,formatter:function(){return addComma(this.value.toFixed(w))}},title:""},series:[{name:k,data:d,type:e}],exporting:{enabled:!1,enableImages:!1},legend:{enabled:!1},navigator:{enabled:!0},plotOptions:{line:{marker:{radius:2}},candlestick:{lineColor:"black",color:"red",upColor:"green",upLineColor:"black",shadow:!0}},rangeSelector:{enabled:!1}},n=new Highcharts.Chart(m);return n.addPlotLineX=function(a){n.xAxis[0].addPlotLine({value:a.value,id:a.id||a.value,label:{text:a.label||"label",x:a.text_left?-15:5},color:a.color||"#e98024",zIndex:4,width:a.width||2,dashStyle:a.dashStyle})},n.addPlotLineY=function(a){n.yAxis[0].addPlotLine({id:a.id||a.label,value:a.value,label:{text:a.label,align:"center",y:a.text_under?15:-5},color:a.color||"green",zIndex:4,width:2})},l.chart=n},B=a.init=function(a,b){return new Promise(function(c,d){return v[b]?(v[b].moveToTop(),void c()):void o["default"].send({proposal_open_contract:1,contract_id:a}).then(function(a){var d=a.proposal_open_contract;return void 0===d.underlying&&void 0===d.shortcode?void z(d):(d.transaction_id=b,H(d),void c())})["catch"](function(a){m["default"].growl.error({message:a.message}),d()})})},C=function(a){m["default"].growl.error({message:a}),o["default"].proposal_open_contract.forget(data.echo_req.contract_id),o["default"].proposal_open_contract.subscribe(data.echo_req.contract_id)},D=function(a,b){function c(a,b){b.proposal_open_contract.user_sold=a.exit_tick_time&&a.exit_tick_time<a.date_expiry,b.proposal_open_contract.current_spot=a.current_spot,b.proposal_open_contract.current_spot_time=a.current_spot_time,b.proposal_open_contract.bid_price=a.bid_price,b.proposal_open_contract.entry_tick=a.entry_tick,b.proposal_open_contract.entry_tick_time=a.entry_tick_time,b.proposal_open_contract.status=a.status,b.proposal_open_contract.is_sold=a.is_sold,b.proposal_open_contract.exit_tick=a.exit_tick,b.proposal_open_contract.exit_tick_time=a.exit_tick_time,b.proposal_open_contract.date_expiry=a.date_expiry,b.proposal_open_contract.sell_price=a.sell_price,b.proposal_open_contract.is_valid_to_sell=a.is_valid_to_sell,b.proposal_open_contract.barrier=a.barrier,b.proposal_open_contract.high_barrier=a.high_barrier,b.proposal_open_contract.low_barrier=a.low_barrier,b.note=F(a)}function d(){if(f.bid_price){b.sell.bid_price.value=f.bid_price;var a=f.bid_price.toString().split(/[\.,]+/),c=u(a,2);b.sell.bid_price.unit=c[0],b.sell.bid_price.cent=c[1]}}function e(){var a=f.is_forward_starting&&+f.date_start>+f.current_spot_time;return a?void(b.fwd_starting="* Contract has not started yet".i18n()):void(b.fwd_starting="")}var f=a.proposal_open_contract;c(f,b),j(f,b);var g="open"!==f.status;return g?void E(b):(d(),e(),void b.chart.manual_reflow())},E=function(a){a.proposal_open_contract.is_ended=!0,a.sell.sell_at_market_enabled=!1},F=function(a){return a.validation_error?a.validation_error:"open"!==a.status?x.FINISHED:a.is_expired||a.is_sold?x.EXPIRED:a.is_valid_to_sell?x.MARKET_RATE:a.is_valid_to_sell?void 0:x.NO_RESALE},G=function(a,b){b.sell.bid_prices.length>40&&b.sell.bid_prices.shift(),b.sell.bid_prices.push(a.bid_price)},H=function(a){require(["text!viewtransaction/viewTransaction.html"],function(b){var c=m["default"](b).i18n(),d=J(a,c),e=n["default"].createBlankWindow(c,{title:a.display_name+" ("+a.transaction_id+")",width:700,minWidth:490,minHeight:480,height:480,destroy:function(){},close:function(){f&&f.unbind(),o["default"].proposal_open_contract.forget(a.contract_id),o["default"].events.off("proposal_open_contract",K);for(var b=0;b<d.onclose.length;++b)d.onclose[b]();m["default"](this).dialog("destroy").remove(),v[a.transaction_id]=void 0},open:function(){o["default"].proposal_open_contract.forget(a.contract_id)},resize:function(){d.chart.manual_reflow()},"data-authorized":"true"});e.dialog("open");var f=q["default"].bind(c[0],d);v[a.transaction_id]=e})},I=function(a,b){a.sell.sell_at_market_enabled=!1,require(["text!viewtransaction/viewTransactionConfirm.html","css!viewtransaction/viewTransactionConfirm.css"]),o["default"].send({sell:a.proposal_open_contract.contract_id,price:0}).then(function(c){a.proposal_open_contract.user_sold=!0;var d=c.sell;require(["text!viewtransaction/viewTransactionConfirm.html","css!viewtransaction/viewTransactionConfirm.css"],function(c){var e=a.proposal_open_contract,f=e.buy_price,g=e.longcode,h=e.currency,i={longcode:g,buy_price:f,sell_price:d.sold_for,return_percent:(100*(d.sold_for-f)/f).toFixed(2)+"%",transaction_id:d.transaction_id,balance:d.balance_after,currency:h},j=m["default"](c).i18n();b.after(j);var k=q["default"].bind(j[0],i);a.onclose.push(function(){k&&k.unbind()})})})["catch"](function(a){m["default"].growl.error({message:a.message})})},J=function(a,b){var c={route:{value:"table",update:function(a){c.route.value=a}},note:F(a),chart:{chart:null,loading:"Loading "+a.display_name+" ...",added_labels:[],type:"ticks",manual_reflow:function(){if(c.chart.chart){var a=-1*(b.find(".longcode").height()+b.find(".tabs").height()+b.find(".footer").height())-16,d=b,e=d.width()-10,f=d.height();return c.chart.chart.setSize(e,f+a,!1),c.chart.chart.hasUserSize=null,c.chart.chart.series[0]&&0===c.chart.chart.series[0].data.length?void c.chart.chart.showLoading():void c.chart.chart.hideLoading()}}},proposal_open_contract:t({},a,{currency:(a.currency||"USD")+" ",is_ended:a.is_settleable||a.is_sold||"open"!==a.status,is_sold_at_market:!1,user_sold:a.exit_tick_time&&a.exit_tick_time<a.date_expiry,isLookback:s["default"].isLookback(a.contract_type),lb_formula:s["default"].formula(a.contract_type,a.multiplier&&formatPrice(a.multiplier,a.currency||"USD"))}),sell:{bid_prices:[],bid_price:{unit:void 0,cent:void 0,value:void 0},sell:function(){return I(c,b)},sell_at_market_enabled:!0},onclose:[]};return N(c,b),c},K=void 0,L=function(a,b){function c(){if(p["default"][h])p["default"].subscribe(h);else{var c=d(b,a.proposal_open_contract.underlying);p["default"].register(c)["catch"](function(a){m["default"].growl.error({message:a.message})})}}function d(a,b){return{symbol:b,subscribe:1,granularity:a,style:0===a?"ticks":"candles"}}function e(){function b(a,b){a&&a.series[0].addPoint([1e3*b.epoch,1*b.quote])}i=o["default"].events.on("tick",function(c){if(c.tick&&c.tick.symbol===a.proposal_open_contract.underlying){var d=a.chart.chart,e=a.proposal_open_contract,f=e.status,h=e.is_sold,i=e.exit_tick,j=e.exit_tick_time,k=c.tick,l=h||"open"!==f||i||j;return l?void g():void b(d,k)}})}function f(){j=o["default"].events.on("ohlc",function(b){var c=p["default"].keyFor(b.ohlc.symbol,b.ohlc.granularity);if(h===c){var d=a.chart.chart;if(d){var e=d.series[0],f=e.data[e.data.length-1],i=b.ohlc,j=[1e3*i.open_time,1*i.open,1*i.high,1*i.low,1*i.close];f.x!==j[0]?e.addPoint(j,!0,!0):f.update(j,!0);var k=a.proposal_open_contract,l=k.status,m=(k.is_sold,k.exit_tick),n=k.exit_tick_time,o=k.date_expiry,q=1*i.epoch>1*o||"open"!==l||m||n;q&&g()}}})}function g(){k||(k=!0,p["default"].unregister(h),i&&o["default"].events.off("tick",i),j&&o["default"].events.off("candles",j))}var h=p["default"].keyFor(a.proposal_open_contract.underlying,b);c(h);var i=void 0,j=void 0,k=!1;return a.onclose.push(g),0===b?void e():void f()},M=function(a,b){function c(a,b,c){function d(a,b,c,d,f){e.addPlotLineY({id:a,value:b,label:c,color:d,text_under:f})}if(a){var f="Barrier".i18n()+" ( "+addComma((+a).toFixed(w))+" )";d("barrier",a,f)}if(b){var g="High Barrier".i18n()+" ( "+addComma((+b).toFixed(w))+" )";d("high_barrier",b,g)}if(c){var h="Low Barrier".i18n()+" ( "+addComma((+c).toFixed(w))+" )";d("low_barrier",c,h,"red",!0)}}function d(a,b,c){a&&e.yAxis[0].removePlotLine("barrier"),b&&e.yAxis[0].removePlotLine("high_barrier"),c&&e.yAxis[0].removePlotLine("low_barrier")}var e=b.chart.chart,f=b.proposal_open_contract,g=f.barrier,h=f.high_barrier,i=f.low_barrier;d(g,h,i),c(g,h,i)},N=function(a,b){function c(a){var b=0;return b=3600>=a?0:7200>=a?60:21600>=a?120:86400>=a?300:3600}function d(a,b){var c=0;return c=0===b?Math.max(3,30*a/3600|0):3*b}function e(b,c){var d=a.proposal_open_contract,e=d.is_forward_starting,f=d.date_start,g=d.current_spot_time,h=d.purchase_time,i=d.exit_tick_time,j=e&&+f>+g||+f>+i,k=j?+h:+f||+h,l=k>i||!i?"latest":+i+c,m={adjust_start_time:1,ticks_history:a.proposal_open_contract.underlying,start:k-c,end:l,style:"ticks",count:4999};return 0!==b&&(m.granularity=b,m.style="candles",a.chart.type="candles"),m}function f(c){function d(a,b){return t({title:b},a)}a.chart.loading="";var e=d(c,a.proposal_open_contract.display_name),f=A(b,a,e);a.chart.chart=f,a.chart.manual_reflow()}function g(b){a.chart.loading=b.message}var h=Math.min(+a.proposal_open_contract.date_expiry,r["default"].utc().unix())-(a.proposal_open_contract.purchase_time||a.proposal_open_contract.date_start),i=c(h),j=d(h,i),k=e(i,j);a.proposal_open_contract.is_ended||L(a,i),o["default"].send(k).then(function(b){f(b),l(a,a.proposal_open_contract)})["catch"](function(a){g(a)})};a["default"]={init:B}});