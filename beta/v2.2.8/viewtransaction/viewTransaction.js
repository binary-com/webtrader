define(["exports","jquery","windows/windows","websockets/binary_websockets","charts/chartingRequestMap","common/rivetsExtra","moment","../charts/chartSettings","trade/lookback","common/util"],function(a,b,c,d,e,f,g,h,i){"use strict";function j(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b}function k(a){return a&&a.__esModule?a:{"default":a}}function l(a,b){L(a,b);var c=b.chart.chart;c&&(n(a,b,c),o(a,b,c),R(a,b),m(a,b,c))}function m(a,b,c){function d(a){var d=a.spot_time,e=a.label,f=a.zone_idx;d&&!b.chart.hasLabel(e)&&(c.series[0].zones[f].value=1e3*+d)}var e=a.entry_tick_time,f=a.exit_tick_time,g=a.date_expiry,h=a.sell_time,i=b.proposal_open_contract.is_sold_before_expiry;d({spot_time:e,label:"entry_zone",zone_idx:0}),i&&d({spot_time:f||h,label:"exit_zone",zone_idx:1}),d({spot_time:f||g,label:"exit_zone",zone_idx:1})}function n(a,b,c){function d(a){var d=a.spot_time,e=a.label,f=a.color;if(d&&!b.chart.hasLabel(e)){var g=c.series[0].data.find(function(a){return+a.x===1e3*+d});if(g){var h=w.getMarkerSettings(f);g.update({marker:h})}}}var e=a.entry_tick_time,f=a.exit_tick_time,g=a.tick_count,h=a.is_path_dependent,i=b.proposal_open_contract.is_sold_before_expiry;g||(d({spot_time:e,label:"entry_tick_time",color:"white"}),h&&f&&d({spot_time:f,label:"exit_tick_time",color:"orange"}),i||d({spot_time:f,label:"exit_tick_time",color:"orange"}))}function o(a,b,c){function d(a){var d=a.line_time,e=a.label,f=a.dashStyle,g=a.color;return!d||b.chart.hasLabel(e)?!1:void c.addPlotLineX({value:1e3*+d,dashStyle:f,color:g})}function e(a){var c=a.is_path_dependent,e=b.proposal_open_contract.is_sold_before_expiry;c&&h&&e&&d({line_time:h,label:"end_time",dashStyle:"Dash"}),e&&d({line_time:l,label:"end_time",dashStyle:"Dash"}),c||d({line_time:i,label:"end_time",dashStyle:"Dash"})}function f(a){var b=a.purchase_time;j>b&&d({line_time:b,label:"purchase_time",color:"#7cb5ec"})}var g=a.entry_tick_time,h=a.exit_tick_time,i=a.date_expiry,j=a.date_start,k=a.tick_count,l=a.sell_time;return k?(d({line_time:g,label:"start_time"}),void d({line_time:h,label:"end_time",dashStyle:"Dash"})):(d({line_time:j,label:"start_time"}),e(a),void f(a))}function p(a,b){function c(b){var c=+b.proposal_open_contract.contract_id!==+a.proposal_open_contract.contract_id;if(!c)return b.error?void H(b.error.message):void I(b,a)}P=c,s["default"].proposal_open_contract.subscribe(b.contract_id),s["default"].events.on("proposal_open_contract",P)}Object.defineProperty(a,"__esModule",{value:!0}),a.init=void 0;var q=k(b),r=k(c),s=k(d),t=k(e),u=k(f),v=k(g),w=j(h),x=k(i),y=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a},z=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();require(["css!viewtransaction/viewTransaction.css"]),require(["text!viewtransaction/viewTransaction.html"]);var A={},B=3,C={EXPIRED:"This contract has expired".i18n(),MARKET_RATE:"Note: Contract will be sold at the prevailing market price when the request is received by our servers. This price may differ from the indicated price.".i18n(),NO_RESALE:"Resale of this contract is not offered".i18n(),FINISHED:"This contract has expired".i18n()},D=null,E=function(){if(D)return void D.moveToTop();var a="There was a market data disruption during the contract period. For real-money accounts we will attempt to correct this and settle the contract properly, otherwise the contract will be cancelled and refunded. Virtual-money contracts will be cancelled and refunded.".i18n(),b=q["default"]('<div class="data-disruption-dialog">'+a+"</div>");D=r["default"].createBlankWindow(b,{title:" There was an error ".i18n(),height:200,resizable:!1,collapsable:!1,minimizable:!1,maximizable:!1,destroy:function(){D&&D.dialog("destroy").remove(),D=null},"data-authorized":"true"}),D.dialog("open"),window.dd=D},F=function(a,b,c){var d=[],e="",f=0;if(c.history){e="line";for(var g=c.history,h=g.times,i=g.prices,j=0;j<h.length;++j)d.push([1e3*h[j],1*i[j]]),f=Math.max(f,i[j].substring(i[j].indexOf(".")+1).length)}c.candles&&(e="candlestick",d=c.candles.map(function(a){return[1e3*a.epoch,1*a.open,1*a.high,1*a.low,1*a.close]}));var k=c.title,l=a.find(".transaction-chart")[0],m=w.getChartLabels(b.proposal_open_contract),n=b.proposal_open_contract,o=n.entry_tick_time,p=n.date_start,q=o||p,r={credits:{href:"#",text:""},chart:{type:"line",renderTo:l,backgroundColor:null,width:0,height:0,marginLeft:65,marginRight:20},title:{text:""},subtitle:{text:w.getLabelEl(m),useHTML:!0},tooltip:{useHTML:!0,formatter:function(){var a=addComma(this.y.toFixed(B)),b=v["default"].utc(this.x).format("dddd, MMM D, HH:mm:ss");return"<div class='tooltip-body'>"+b+" GMT<br/>"+this.series.name+" "+a+"</div>"}},xAxis:{type:"datetime",categories:null,startOnTick:!1,endOnTick:!1,min:d.length?d[0][0]:null,max:d.length?d[d.length-1][0]:null,labels:{overflow:"justify",format:"{value:%H:%M:%S}"}},yAxis:{labels:{align:"left",x:-65,y:-2,formatter:function(){return addComma(this.value.toFixed(B))}},title:""},series:[{name:k,data:d,type:e,zIndex:10,zoneAxis:"x",zones:[{value:q?1e3*+q:"",color:"#ccc"},{color:""},{color:"#ccc"}]}],exporting:{enabled:!1,enableImages:!1},legend:{enabled:!1},navigator:{enabled:!0},plotOptions:{line:{marker:{radius:2}},candlestick:{lineColor:"black",color:"red",upColor:"green",upLineColor:"black",shadow:!0}},rangeSelector:{enabled:!1}},s=new Highcharts.Chart(r);return s.addPlotLineX=function(a){s.xAxis[0].addPlotLine({value:a.value,id:a.id||a.value,color:a.color||"#e98024",zIndex:0,width:a.width||2,dashStyle:a.dashStyle})},s.addPlotLineY=function(a){s.yAxis[0].addPlotLine({id:a.id,value:a.value,color:a.color||"green",zIndex:0,width:2,dashStyle:a.dashStyle})},l.chart=s},G=a.init=function(a,b){return new Promise(function(c,d){return A[b]?(A[b].moveToTop(),void c()):void s["default"].send({proposal_open_contract:1,contract_id:a}).then(function(a){var d=a.proposal_open_contract;return void 0===d.underlying&&void 0===d.shortcode?void E(d):(d.transaction_id=b,M(d),void c())})["catch"](function(a){q["default"].growl.error({message:a.message}),d()})})},H=function(a){q["default"].growl.error({message:a}),s["default"].proposal_open_contract.forget(data.echo_req.contract_id),s["default"].proposal_open_contract.subscribe(data.echo_req.contract_id)},I=function(a,b){function c(a,b){var c=a.is_path_dependent&&"sold"!==a.status?a.exit_tick_time:parseInt(a.sell_time);b.proposal_open_contract.is_sold_before_expiry=c<a.date_expiry,b.proposal_open_contract.current_spot=a.current_spot,b.proposal_open_contract.current_spot_time=a.current_spot_time,b.proposal_open_contract.bid_price=a.bid_price,b.proposal_open_contract.entry_tick=a.entry_tick,b.proposal_open_contract.entry_tick_time=a.entry_tick_time,b.proposal_open_contract.status=a.status,b.proposal_open_contract.is_sold=a.is_sold,b.proposal_open_contract.exit_tick=a.exit_tick,b.proposal_open_contract.exit_tick_time=a.exit_tick_time,b.proposal_open_contract.date_expiry=a.date_expiry,b.proposal_open_contract.sell_price=a.sell_price,b.proposal_open_contract.is_valid_to_sell=a.is_valid_to_sell,b.proposal_open_contract.barrier=a.barrier,b.proposal_open_contract.high_barrier=a.high_barrier,b.proposal_open_contract.low_barrier=a.low_barrier,b.note=K(a)}function d(){if(f.bid_price){b.sell.bid_price.value=f.bid_price;var a=f.bid_price.toString().split(/[\.,]+/),c=z(a,2);b.sell.bid_price.unit=c[0],b.sell.bid_price.cent=c[1]}}function e(){var a=f.is_forward_starting&&+f.date_start>+f.current_spot_time;return a?void(b.fwd_starting="* Contract has not started yet".i18n()):void(b.fwd_starting="")}var f=a.proposal_open_contract;c(f,b),l(f,b);var g="open"!==f.status;return g?void J(b):(d(),e(),void b.chart.manualReflow())},J=function(a){a.proposal_open_contract.is_ended=!0,a.sell.sell_at_market_enabled=!1},K=function(a){return a.validation_error?a.validation_error:"open"!==a.status?C.FINISHED:a.is_expired||a.is_sold?C.EXPIRED:a.is_valid_to_sell?C.MARKET_RATE:a.is_valid_to_sell?void 0:C.NO_RESALE},L=function(a,b){b.sell.bid_prices.length>40&&b.sell.bid_prices.shift(),b.sell.bid_prices.push(a.bid_price)},M=function(a){require(["text!viewtransaction/viewTransaction.html"],function(b){var c=q["default"](b).i18n(),d=O(a,c),e=r["default"].createBlankWindow(c,{title:a.display_name+" ("+a.transaction_id+")",width:700,minWidth:630,minHeight:480,height:480,destroy:function(){},close:function(){f&&f.unbind(),s["default"].proposal_open_contract.forget(a.contract_id),s["default"].events.off("proposal_open_contract",P);for(var b=0;b<d.onclose.length;++b)d.onclose[b]();q["default"](this).dialog("destroy").remove(),A[a.transaction_id]=void 0},open:function(){s["default"].proposal_open_contract.forget(a.contract_id)},resize:function(){d.chart.manualReflow()},"data-authorized":"true"});e.dialog("open");var f=u["default"].bind(c[0],d);A[a.transaction_id]=e})},N=function(a,b){a.sell.sell_at_market_enabled=!1,require(["text!viewtransaction/viewTransactionConfirm.html","css!viewtransaction/viewTransactionConfirm.css"]),s["default"].send({sell:a.proposal_open_contract.contract_id,price:0}).then(function(c){a.proposal_open_contract.is_sold_before_expiry=!0;var d=c.sell;require(["text!viewtransaction/viewTransactionConfirm.html","css!viewtransaction/viewTransactionConfirm.css"],function(c){var e=a.proposal_open_contract,f=e.buy_price,g=e.longcode,h=e.currency,i={longcode:g,buy_price:f,sell_price:d.sold_for,return_percent:(100*(d.sold_for-f)/f).toFixed(2)+"%",transaction_id:d.transaction_id,balance:d.balance_after,currency:h},j=q["default"](c).i18n();b.after(j);var k=u["default"].bind(j[0],i);a.onclose.push(function(){k&&k.unbind()})})})["catch"](function(a){q["default"].growl.error({message:a.message})})},O=function(a,b){var c=a.is_path_dependent&&"sold"!==a.status?a.exit_tick_time:parseInt(a.sell_time),d={route:{value:"table",update:function(a){d.route.value=a}},note:K(a),chart:{chart:null,loading:"Loading "+a.display_name+" ...",added_labels:[],hasLabel:function(a){return d.chart.added_labels.includes(a)?!0:(d.chart.added_labels.push(a),!1)},type:"ticks",manualReflow:function(){if(d.chart.chart){var a=-1*(b.find(".longcode").height()+b.find(".tabs").height()+b.find(".footer").height())-16,c=b,e=c.width()-10,f=c.height();return d.chart.chart.setSize(e,f+a,!1),d.chart.chart.hasUserSize=null,d.chart.chart.series[0]&&0===d.chart.chart.series[0].data.length?void d.chart.chart.showLoading():void d.chart.chart.hideLoading()}}},proposal_open_contract:y({},a,{currency:(a.currency||"USD")+" ",is_ended:a.is_settleable||a.is_sold||"open"!==a.status,is_sold_at_market:!1,is_sold_before_expiry:c<a.date_expiry,isLookback:x["default"].isLookback(a.contract_type),lb_formula:x["default"].formula(a.contract_type,a.multiplier&&formatPrice(a.multiplier,a.currency||"USD"))}),sell:{bid_prices:[],bid_price:{unit:void 0,cent:void 0,value:void 0},sell:function(){return N(d,b)},sell_at_market_enabled:!0},onclose:[]};return S(d,b),d},P=void 0,Q=function(a,b){function c(){if(t["default"][h])t["default"].subscribe(h);else{var c=d(b,a.proposal_open_contract.underlying);t["default"].register(c)["catch"](function(a){q["default"].growl.error({message:a.message})})}}function d(a,b){return{symbol:b,subscribe:1,granularity:a,style:0===a?"ticks":"candles"}}function e(){function b(a,b){a&&a.series[0].addPoint([1e3*b.epoch,1*b.quote,"gray"])}i=s["default"].events.on("tick",function(c){if(c.tick&&c.tick.symbol===a.proposal_open_contract.underlying){var d=a.chart.chart,e=a.proposal_open_contract,f=e.status,h=e.is_sold,i=e.exit_tick,j=e.exit_tick_time,k=c.tick,l=h||"open"!==f||i||j;return l?void g():void b(d,k)}})}function f(){j=s["default"].events.on("ohlc",function(b){var c=t["default"].keyFor(b.ohlc.symbol,b.ohlc.granularity);if(h===c){var d=a.chart.chart;if(d){var e=d.series[0],f=e.data[e.data.length-1],i=b.ohlc,j=[1e3*i.open_time,1*i.open,1*i.high,1*i.low,1*i.close];f.x!==j[0]?e.addPoint(j,!0,!0):f.update(j,!0);var k=a.proposal_open_contract,l=k.status,m=(k.is_sold,k.exit_tick),n=k.exit_tick_time,o=k.date_expiry,p=1*i.epoch>1*o||"open"!==l||m||n;p&&g()}}})}function g(){k||(k=!0,t["default"].unregister(h),i&&s["default"].events.off("tick",i),j&&s["default"].events.off("candles",j))}var h=t["default"].keyFor(a.proposal_open_contract.underlying,b);c(h);var i=void 0,j=void 0,k=!1;return a.onclose.push(g),0===b?void e():void f()},R=function(a,b){function c(a,b,c){var d=j?"":"dot";a&&e.addPlotLineY({id:"barrier",value:a,dashStyle:d}),b&&e.addPlotLineY({id:"high_barrier",value:b,dashStyle:d}),c&&e.addPlotLineY({id:"low_barrier",value:c,dashStyle:d})}function d(a,b,c){a&&e.yAxis[0].removePlotLine("barrier"),b&&e.yAxis[0].removePlotLine("high_barrier"),c&&e.yAxis[0].removePlotLine("low_barrier")}var e=b.chart.chart,f=b.proposal_open_contract,g=f.barrier,h=f.high_barrier,i=f.low_barrier,j=f.tick_count;d(g,h,i),c(g,h,i)},S=function(a,b){function c(a){var b=0;return b=3600>=a?0:7200>=a?60:21600>=a?120:86400>=a?300:3600}function d(a,b){var c=0;return c=0===b?Math.max(3,30*a/3600|0):3*b}function e(b,c){var d=a.proposal_open_contract,e=d.date_start,f=d.current_spot_time,g=d.purchase_time,h=d.exit_tick_time,i=+e>+g,j=void 0;if(i)j=g;else{var k=+e>+f||+e>+h;j=k?+g:+e||+g}var l=j>h||!h?"latest":+h+c,m={adjust_start_time:1,ticks_history:a.proposal_open_contract.underlying,start:j-c,end:l,style:"ticks",count:4999};return 0!==b&&(m.granularity=b,m.style="candles",a.chart.type="candles"),m}function f(c){function d(a,b){return y({title:b},a)}a.chart.loading="";var e=d(c,a.proposal_open_contract.display_name),f=F(b,a,e);a.chart.chart=f,a.chart.manualReflow()}function g(b){a.chart.loading=b.message}var h=Math.min(+a.proposal_open_contract.date_expiry,v["default"].utc().unix())-(a.proposal_open_contract.purchase_time||a.proposal_open_contract.date_start),i=c(h),j=d(h,i),k=e(i,j);a.proposal_open_contract.is_ended||Q(a,i),s["default"].send(k).then(function(b){f(b),p(a,a.proposal_open_contract)})["catch"](function(a){g(a)})};a["default"]={init:G}});