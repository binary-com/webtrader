define(["windows/windows","websockets/binary_websockets","lodash"],function(a,b){function c(){g=f,f={},h();var a={assetIndex:"#nav-container .assetIndex",statement:"#nav-container .statement",tradingTimes:"#nav-container .tradingTimes",download:"#nav-container .download",portfolio:"#nav-container .portfolio",profitTable:"#nav-container .profitTable",token:"#nav-container .token-management"},c=0,d=function(d,e){"closed"!==d.position.mode&&(d.is_unique?d.is_authorized?b.events.on_till("login",function(){return $(a[e]).click(),!0}):$(a[e]).click():"chartWindow"===e?(d.data.tracker_id=++c,require(["charts/chartWindow"],function(a){a.addNewWindow(d.data)})):"tradeDialog"===e&&b.events.on_till("login",function(){return d.data.tracker_id=++c,b.send({contracts_for:d.data.symbol}).then(function(a){require(["trade/tradeDialog"],function(b){b.init(d.data,a.contracts_for)})})["catch"](void 0),!0}))};_.forEach(g,function(a,b){_.isArray(a)?a.forEach(function(a){d(a,b)}):d(a,b)})}function d(a,b,c,d){var e=d.position;e.size&&b.dialog("option","width",e.size.width),e.size&&b.dialog("option","height",e.size.height),c.position.size=e.size,c.position.mode=e.mode,"maximized"===e.mode?setTimeout(function(){b.dialogExtend("maximize"),b.dialog("moveToTop")},10):"minimized"===e.mode&&b.dialogExtend("minimize"),e.offset&&(a.css({left:e.offset.left+"px",top:e.offset.top+"px"}),c.position.offset=e.offset),h()}function e(a,b){var c=b.dialog("widget"),e=null,i={module_id:a.module_id,is_unique:a.is_unique,is_authorized:"true"===b.attr("data-authorized"),data:a.data,position:{size:{width:b.dialog("option","width"),height:b.dialog("option","height")},offset:void 0,mode:"normal"}};if(a.is_unique)f[a.module_id]=i,e=g[a.module_id],e&&("closed"===e.position.mode&&(e=null),delete g[a.module_id]);else if(f[a.module_id]=f[a.module_id]||[],f[a.module_id].push(i),g[a.module_id]&&void 0!==i.data.tracker_id){var j=_.findIndex(g[a.module_id],function(a){return a.data.tracker_id===i.data.tracker_id});-1!==j&&(e=g[a.module_id][j],g[a.module_id].splice(j,1),"closed"===e.position.mode&&(e=null))}return h(),c.on("dragstop",function(){i.position.offset=c.offset(),h()}),c.on("animated",function(){i.position.offset=c.offset(),h()}),c.on("resizestop",function(a,b){i.position.size=b.size,i.position.offset=c.offset(),h()}),b.on("dialogextendminimize",function(){i.position.mode="minimized",h()}),b.on("dialogextendmaximize",function(){i.position.mode="maximized",h()}),b.on("dialogextendrestore",function(){i.position.offset=c.offset(),i.position.mode="normal",h()}),b.on("dialogdestroy",function(){if(i.is_unique)delete f[i.module_id];else{var a=f[i.module_id].indexOf(i);1==f[i.module_id].length?delete f[i.module_id]:f[i.module_id].splice(a,1)}h()}),b.on("dialogclose",function(){i.position.mode="closed",h()}),b.on("dialogopen",function(){i.position.offset=c.offset(),i.position.mode="normal",h(),e&&(d(c,b,i,e),e=null)}),function(a){i.data=a,h()}}var f=local_storage.get("states")||{},g={},h=_.debounce(function(){local_storage.set("states",f)},50);return{track:e,reopen:c,is_empty:function(){var a=_.values(f).filter(function(a){return _.isArray(a)||"closed"!==a.position.mode});return 0===a.length}}});