define(["jquery","charts/chartingRequestMap","moment","charts/chartWindow","common/util"],function(a,b,c){"use strict";function d(b,c){var d=a("#"+b+"_header").find("li.overlay");isDataTypeClosePriceOnly(c)?d.removeClass("ui-state-disabled"):d.addClass("ui-state-disabled"),d.closest("ul.ui-menu").menu("refresh")}function e(a){var d=isTick(a.timePeriod),e=b.keyFor(a.instrumentCode,a.timePeriod),g=a.instrumentName+" ("+a.timePeriod+").csv",h=f.chain().find({instrumentCdAndTp:e}).simplesort("time",!1).data(),i=h.map(function(a){return d?'"'+c.utc(a.time).format("YYYY-MM-DD HH:mm")+'",'+ +a.open:'"'+c.utc(a.time).format("YYYY-MM-DD HH:mm")+'",'+a.open+","+a.high+","+a.low+","+a.close}),j=(d?"Date,Tick\n":"Date,Open,High,Low,Close\n")+i.join("\n"),k=new Blob([j],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(k,g);else{var l=document.createElement("a");if(void 0!==l.download){var m=URL.createObjectURL(k);l.setAttribute("href",m),l.setAttribute("download",g),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l)}}}var f=b.barsTable;return{init:function(b,c,f,g){require(["text!charts/chartOptions.html","css!charts/chartOptions.css"],function(h){h=a(h),h.find(".chartMenuHamburgerMenu").hover(function(){a(this).toggleClass("ui-state-hover").toggleClass("ui-state-active")}).click(function(){return a(this).toggleClass("active").next("ul:first").toggle(),!1}).focusout(function(){a(this).removeClass("active").next("ul:first").menu().hide()}),h.find("ul:first").menu(),isTick(c)&&h.find(".candlestick, .ohlc").addClass("ui-state-disabled"),g||h.find(".chartType li.table").hide(),h.find(".chartType li."+f).find("span:first").addClass("ui-icon ui-icon-check"),h.find(".chartType li").click(function(){if(!a(this).hasClass("ui-state-disabled")){var c=a(this).attr("class").split(" ")[0].replace(".","").trim();if("table"===c)g();else if("export"===c){var f=a("#"+b+"_chart").data();e(f)}else h.find(".chartType li span").removeClass("ui-icon ui-icon-check"),a(this).find("span:first").addClass("ui-icon ui-icon-check"),a("#"+b+"_chart").data("type",c),require(["charts/charts"],function(a){a.refresh("#"+b+"_chart")});d(b,c),a(this).closest(".chartOptions").find(".chartMenuHamburgerMenu").click()}}),h.find("ul:first > li").each(function(){a(this).click(function(){if(!a(this).hasClass("ui-state-disabled"))if(a(this).hasClass("logScaleLI")){var c=a("#"+b+"_chart").highcharts().series[0],d=a(this).find("span:first").hasClass("ui-icon-check");c.yAxis.update({type:d?"linear":"logarithmic"}),a(this).find("span:first").toggleClass("ui-icon ui-icon-check");var e=a(this).closest(".chartOptions").find(".chartMenuHamburgerMenu");e.hasClass("active")&&e.click()}else a(this).hasClass("crosshairLI")?(require(["charts/crosshair"],function(a){a.toggleCrossHair("#"+b+"_chart")}),a(this).find("span:first").toggleClass("ui-icon ui-icon-check"),a(this).closest(".chartOptions").find(".chartMenuHamburgerMenu").click()):a(this).hasClass("refresh")?(require(["charts/charts"],function(a){a.refresh("#"+b+"_chart")}),a(this).closest(".chartOptions").find(".chartMenuHamburgerMenu").click()):a(this).hasClass("currentPriceLI")&&(require(["currentPriceIndicator"],function(c){var d="#"+b+"_chart",e=a(d).highcharts(),f=!1;a.each(e.series,function(b,d){a.each(c.getCurrentPriceOptions(),function(a,b){b&&d.options&&d.options.id&&b.parentSeriesID==d.options.id&&(d.removeCurrentPrice(a),f=!0)})}),f||e.series.forEach(function(a){a.options.isInstrument&&a.addCurrentPrice()})}),a(this).find("span:first").toggleClass("ui-icon ui-icon-check"),a(this).closest(".chartOptions").find(".chartMenuHamburgerMenu").click())})}),h.find(".indicators li").click(function(){a(this).hasClass("addInidicators")?require(["charts/indicators/indicators_add"],function(a){a.openDialog("#"+b+"_chart")}):a(this).hasClass("removeIndicators")&&require(["charts/indicators/indicators_remove"],function(a){a.openDialog("#"+b+"_chart")})}),h.find(".overlay li").click(function(){a(this).hasClass("addOverlay")?require(["overlay/overlay_add"],function(a){a.openDialog("#"+b+"_chart")}):a(this).hasClass("removeOverlay")&&require(["overlay/overlay_remove"],function(a){a.openDialog("#"+b+"_chart")})}),h.find(".drawLI li").click(function(){a(this).hasClass("addChartObject")?require(["charts/draw/chartobject_add"],function(a){a.openDialog("#"+b+"_chart")}):a(this).hasClass("removeChartObject")&&require(["charts/draw/chartobject_remove"],function(a){a.openDialog("#"+b+"_chart")})}),a("#"+b+"_header").prepend(h),d(b,f)})},disableEnableLogMenu:function(b,c){var d=a("#"+b+"_header").find("li.logScaleLI");c?d.removeClass("ui-state-disabled"):d.addClass("ui-state-disabled")},triggerToggleLogScale:function(b){a("#"+b+"_header").find("li.logScaleLI").click()},isCurrentViewInLogScale:function(b){var c=a("#"+b+"_header").find("li.logScaleLI");return c.find("span:first").hasClass("ui-icon-check")&&!c.hasClass("ui-state-disabled")},disableEnableCandlestick:function(b,c){var d=a("#"+b+"_header").find("li.candlestick");c?d.removeClass("ui-state-disabled"):d.addClass("ui-state-disabled")},disableEnableOHLC:function(b,c){var d=a("#"+b+"_header").find("li.ohlc");c?d.removeClass("ui-state-disabled"):d.addClass("ui-state-disabled")},disableEnableOverlay:function(a,b){d(a,b)}}});