define(["es6-promise","reconnecting-websocket","js-cookie","token/token","jquery-timer"],function(a,b,c,d){function e(){var a="wss://www.binary.com/websockets/v3",c=new b(a,null,{debug:!1,timeoutInterval:5400});return c.onclose=function(){f=!1},c}a.polyfill();var f=!1,g={},h=[],i=[],j={},k={},l=new e,m=function(){return l&&1===l.readyState};l.onopen=function(){for(;i.length>0;)l.send(JSON.stringify(i.shift()));for(;h.length>0;)h.shift()()},l.onmessage=function(a){var b=JSON.parse(a.data);(g[b.msg_type]||[]).forEach(function(a){a(b)});var c=b.echo_req.passthrough&&b.echo_req.passthrough.uid,d=j[c];d&&(delete j[c],b.error?d.reject(b.error):d.resolve(b))},require(["websockets/tick_handler"]),require(["websockets/connection_check"]);var n=function(a){for(prop in{balance:1,statement:1,profit_table:1,portfolio:1,proposal_open_contract:1,buy:1,sell:1})if(prop in a)return!0;return!1},o=function(a){return a.passthrough=a.passthrough||{},a.passthrough.uid=(1e17*Math.random()).toString(),new Promise(function(b,c){j[a.passthrough.uid]={resolve:b,reject:c},m()?l.send(JSON.stringify(a)):i.push(a)})},p=function(a){var b=!1,d=JSON.stringify({authorize:a}),e=o({authorize:a});return e.then(function(g){return c.set("webtrader_token",a),f=!0,b=!0,k[d]=e,g})["catch"](function(a){throw b||(f=!1,c.remove("webtrader_token")),delete k[d],a})},q=function(a){if(f)return o(a);var b=o.bind(null,a);return c.get("webtrader_token")?p(c.get("webtrader_token")).then(b):d.getTokenAsync().then(p).then(b)},r={events:{on:function(a,b){(g[a]=g[a]||[]).push(b)}},execute:function(a){m()?setTimeout(a,0):h.push(a)},cached:{send:function(a){var b=JSON.stringify(a);return k[b]?k[b]:k[b]=r.send(a).then(function(a){return a},function(a){throw delete k[b],a})},authorize:function(){var a=c.get("webtrader_token"),b=JSON.stringify({token:a});return f&&a&&k[b]?k[b]:a?p(a):d.getTokenAsync().then(p)}},send:function(a){return n(a)?q(a):o(a)}};return r});