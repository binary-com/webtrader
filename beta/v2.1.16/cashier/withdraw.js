"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}define(["jquery","websockets/binary_websockets","windows/windows","common/rivetsExtra","cashier/currency","lodash","moment"],function(a,b,c,d,e,f){require(["text!cashier/withdraw.html"]),require(["css!cashier/withdraw.css"]);var g=null,h=null,i=function(b){a.growl.error({message:b.message})},j=function k(){var j=this;_classCallCheck(this,k),this.init=function(a){a.click(function(){g?g.moveToTop():b.cached.authorize().then(function(a){return a.authorize.currency?!0:e.check_currency()}).then(function(){return require(["text!cashier/withdraw.html"],j._init_win)})["catch"](i)})},this._init_win=function(b){b=a(b).i18n(),g=c.createBlankWindow(b,{title:"Withdraw funds",resizable:!0,collapsable:!1,minimizable:!0,maximizable:!0,width:700,height:400,"data-authorized":!0,close:function(){g.dialog("destroy"),g.trigger("dialogclose"),g.remove(),g=null},open:function(){},destroy:function(){h&&h.unbind(),h=null}}),j._init_state(b),g.dialog("open");var d=g.dialog("widget").offset();d.top=110,g.dialog("option","position",{my:d.left,at:d.top}),g.dialog("widget").css({left:d.left+"px",top:d.top+"px"}),g.fixFooterPosition(),g.track({module_id:"withdraw",is_unique:!0})},this._init_state=function(c){var e={route:{value:"menu"},empty_fields:{validate:!1,clear:f.debounce(function(){return e.empty_fields.validate=!1},4e3),show:function(){e.empty_fields.validate=!0,e.empty_fields.clear()}},menu:{choice:""},verify:{token:"",code:"",disabled:!1},transfer:{disabled:!1,account:"",amount:"",loginid:local_storage.get("authorize").loginid},standard:{url:"",iframe_visible:!1},agent:{disabled:!1,loginid:"",name:"",agents:[],commission:"",amount:"",currency:local_storage.get("authorize").currency,residence:"",instructions:""}},j=e.route,k=e.menu,l=e.verify,m=e.empty_fields,n=e.standard,o=e.agent,p=e.transfer,q={menu:400,verify:400,transfer:400,"transfer-done":300,standard:400,agent:550,"agent-confirm":400,"agent-done":300};j.update=function(a){j.value=a,g.dialog("option","height",q[a])},k.click=function(c){if(k.choice=c,j.update("transfer"!==c?"verify":"transfer"),"transfer"!==c){var d=local_storage.get("authorize").email,e="agent"===c?"paymentagent_withdraw":"payment_withdraw";b.send({verify_email:d,type:e}).then(function(){return a.growl.notice({message:"Verification code sent to ".i18n()+d})})["catch"](function(a){i(a),j.update("menu")})}},l.back=function(){l.token=l.code="",j.update("menu")},l.unlock=function(){return l.token?void("standard"===k.choice?(l.disabled=!0,b.send({cashier:"withdraw",verification_code:l.token}).then(function(a){if(a.cashier.startsWith("ASK_"))throw new Error(a.cashier);n.url=a.cashier,l.disabled=!1,j.update("standard"),l.code=l.token,l.token=""})["catch"](function(a){l.disabled=!1,i(a)})):"agent"==k.choice&&(l.code=l.token,l.token="",j.update("agent"))):void m.show()},n.iframe_loaded=function(){n.url&&(n.iframe_visible=!0)},o.onchanged=function(){if(o.loginid){var a=o.agents.find(function(a){return a.paymentagent_loginid==o.loginid}),b=a.withdrawal_commission,c=a.name;o.commission=b,o.name=c}else o.commission="",o.name=""},o.amount_with_commission=function(){var a=(o.amount||0)*(100-o.commission)/100;return a.toFixed(2)},o.click=function(){return o.loginid?o.amount>=10&&o.amount<=2e3?o.instructions?void j.update("agent-confirm"):void m.show():void a.growl.error({message:"Amount Min: 10 Max: 2000".i18n()}):void a.growl.error({message:"Please select a payment agent".i18n()})},o.confirm_transfer=function(){var a={paymentagent_withdraw:1,paymentagent_loginid:o.loginid,currency:o.currency,amount:1*o.amount,verification_code:l.code};o.disabled=!0,b.send(a).then(function(){j.update("agent-done"),o.disabled=!1})["catch"](function(a){o.disabled=!1,j.update("menu"),i(a)})},p.submit=function(){if(""===p.account||""===p.amount)return void m.show();var c={transfer_between_accounts:1,account_from:p.loginid,account_to:p.account,currency:o.currency,amount:p.amount};p.disabled=!0,b.send(c).then(function(b){return 0===b.transfer_between_accounts?void a.growl.error({message:"Transfering funds between accounts failed".i18n()}):void j.update("transfer-done")})["catch"](function(a){i(a),p.disabled=!1})},b.send({get_settings:1}).then(function(a){return o.residence=a.get_settings.country_code,b.cached.send({paymentagent_list:o.residence})}).then(function(a){o.agents=a.paymentagent_list.list})["catch"](i),b.send({payout_currencies:1}).then(function(a){o.currency=a.payout_currencies[0]})["catch"](function(a){return void 0}),h=d.bind(c[0],e)}};return new j});