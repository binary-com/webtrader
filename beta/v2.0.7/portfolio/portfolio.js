define(["jquery","windows/windows","websockets/binary_websockets","jquery-ui","datatables","jquery-growl"],function(a,b,c){function d(a){a.click(function(){h?h.dialog("open"):f()})}function e(b){{var c=b.proposal_open_contract,d=c.contract_id,e=c.ask_price;c.bid_price}if(d&&i){var f=i.api().row("#"+d),g=f.data(),h=g[3];g[3]=e,f.data(g);var j=a("#"+d).find("td:nth-child(4)").find("span");j.removeClass("red green").addClass(1*e>=1*h?"green":"red")}}function f(){c.send({balance:1}).then(function(d){var e=null;h=b.createBlankWindow(a("<div/>"),{title:"Portfolio",width:700,close:function(){e&&clearInterval(e),e=null,c.send({forget_all:"proposal_open_contract"}).then(function(){j={}})["catch"](function(a){})},open:function(){g(),e=setInterval(g,6e4)}});var f=d.balance.currency,k=d.balance.balance,l=h.parent().find(".ui-dialog-title").css("width","25%");a('<span class="span-in-dialog-header" />').html("Account balance: <strong>"+f+" "+formatPrice(k)+"</strong>").insertAfter(l),i=a("<table width='100%' class='display compact'/>"),i.appendTo(h),i=i.dataTable({data:[],columns:[{title:"Ref."},{title:"Contract Details"},{title:"Purchase",render:function(a){return f+' <span class="bold">'+a+"</span>"}},{title:"Indicative",render:function(a){return f+' <span class="bold">'+a+"</span>"}}],rowId:"4",paging:!1,ordering:!1,processing:!0}),i.parent().addClass("hide-search-input"),h.dialog("open")})["catch"](function(b){a.growl.error({message:b.message})}),c.events.on("proposal_open_contract",e)}function g(){var b=a("#"+i.attr("id")+"_processing").show();c.send({portfolio:1}).then(function(d){var e=d.portfolio&&d.portfolio.contracts,f=e.map(function(a){return[a.transaction_id,a.longcode,formatPrice(a.buy_price),"0.00",a.contract_id]});i.api().rows().remove(),i.api().rows.add(f),i.api().draw(),b.hide();var g=function(b){var d=b.contract_id;j[d]!==!0&&(j[d]=!0,c.send({proposal_open_contract:1,contract_id:d})["catch"](function(b){td=a("#"+d).find("td:nth-child(4)"),td.attr("title","").tooltip({content:b.message}),j[d]=!1}))};e.forEach(g)})["catch"](function(c){i.api().rows().remove(),i.api().draw(),b.hide(),a.growl.error({message:c.message})})}var h=null,i=null,j={};return{init:d}});