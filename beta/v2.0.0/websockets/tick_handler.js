define(["websockets/eventSourceHandler","charts/chartingRequestMap","common/util"],function(a,b){function c(a,b,c,e){if(a&&a.chartIDs&&a.chartIDs.length>0){var f=$(a.chartIDs[0].containerIDWithHash).data("timeperiod");if(f){var g=void 0;if(isTick(f))d.insert({instrumentCdAndTp:b,time:c,open:e,high:e,low:e,close:e});else{if(g=d.chain().find({instrumentCdAndTp:b}).simplesort("time",!0).limit(1).data(),!g||g.length<=0)return;g=g[0],e<g.low?g.low=e:e>g.high&&(g.high=e),g.close=e,d.update(g)}for(var h in a.chartIDs){var i=a.chartIDs[h],j=$(i.containerIDWithHash).highcharts();if(j){var k=j.get(b);if(k){var l=$(i.containerIDWithHash).data("type");if(isTick(f))k.addPoint([c,e]);else{var m=k.data[k.data.length-1];l&&isDataTypeClosePriceOnly(l)?m.update([m.x,e]):g&&m.update([m.x,g.open,g.high,g.low,g.close])}}}}}}}var d=b.barsTable;return a.events.on("tick",function(a){var d=a.echo_req.passthrough.instrumentCdAndTp;if(a.error)$(document).trigger("feedTypeNotification",[d,"delayed-feed"]);else if(d){b[d]=b[d]||{},b[d].tickStreamingID=a.tick.id;var e=b[d];if(e){$(document).trigger("feedTypeNotification",[d,"realtime-feed"]);var f=parseFloat(a.tick.quote),g=1e3*parseInt(a.tick.epoch);c(e,d,g,f)}}}),{}});