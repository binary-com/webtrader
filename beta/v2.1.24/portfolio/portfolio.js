define(["exports","babel-runtime/regenerator","jquery","../windows/windows","../websockets/binary_websockets","jquery-ui","datatables","jquery-growl","css!./portfolio.css"],function(a,b,c,d,e){"use strict";function f(a){return a&&a.__esModule?a:{"default":a}}function g(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(i){return void c(i)}return g.done?void a(h):Promise.resolve(h).then(function(a){d("next",a)},function(a){d("throw",a)})}return d("next")})}}Object.defineProperty(a,"__esModule",{value:!0}),a.proposal_open_contract=a.init=void 0;var h=f(b),i=f(c),j=f(d),k=f(e),l=null,m=null,n=null,o="USD",p=[],q=a.init=function(a){a.click(function(){l?l.moveToTop():w()})},r=function(a){if(!a.error){var b=a.proposal_open_contract,c=b.contract_id,d=b.bid_price;if(m){var e=m.api().row("#"+c),f=e.data();if(!f)return;var g=f[3];f[3]=d,e.data(f);var h=m.find("#"+c);b.is_valid_to_sell?(h.removeClass("resale-not-offered"),g!==d&&h.removeClass("indicative-red indicative-green").addClass(1*d>1*g?"indicative-green":"indicative-red")):h.removeClass("indicative-red indicative-green").addClass("resale-not-offered")}}},s=!1,t=0;k["default"].events.on("logout",function(){s=!1,t=0});var u=function B(a){if("subscribe"===a)++t,!s&&t>0&&k["default"].send({proposal_open_contract:1,subscribe:1}).then(function(){s=!0})["catch"](function(a){i["default"].growl.error({message:a.message})});else if("forget"===a)--t,s&&0===t&&k["default"].send({forget_all:"proposal_open_contract"}).then(function(){s=!1})["catch"](function(a){s=!1});else{if("resubscribe"!==a)return;k["default"].send({forget_all:"proposal_open_contract"}).then(function(){s=!1,--t,B("subscribe")})["catch"](function(a){s=!1})}},v=function(a){var b=a.target,c=i["default"](b);if("BUTTON"===b.tagName&&!c.hasClass("button-disabled")){var d=b.parentElement.parentElement,e=m.api().row(d).data();e=_.last(e),c.addClass("button-disabled"),require(["viewtransaction/viewTransaction"],function(a){a.init(e.contract_id,e.transaction_id).then(function(){return c.removeClass("button-disabled")})["catch"](function(){c.removeClass("button-disabled")})})}},w=function(){var a=k["default"].events.on("balance",function(a){void 0!==a.balance&&void 0!==a.balance.currency&&(o=a.balance.currency,n&&n&&n.update(a.balance.balance))}),b=k["default"].events.on("transaction",function(a){var b=a.transaction;if("buy"===b.action){var c="<button>View</button>".i18n(),d=[b.transaction_id,b.longcode,Math.abs(b.amount),"0.00",c,b.contract_id,b];b.date_expiry&&k["default"].sell_expired(b.date_expiry),m.api().rows.add([d]),m.api().draw(),x([b])}else if("sell"===b.action){var e=m.find("#"+b.contract_id)[0];m.api().row(e).remove(),m.api().draw(),y([b])}});k["default"].send({balance:1}).then(function(c){l=j["default"].createBlankWindow(i["default"]("<div/>"),{title:"Portfolio".i18n(),width:700,height:400,"data-authorized":"true",close:function(){y(p),k["default"].events.off("proposal_open_contract",r)},open:function(){z(),k["default"].events.on("proposal_open_contract",r)},destroy:function(){m&&m.DataTable().destroy(!0),l=null,k["default"].events.off("balance",a),k["default"].events.off("transaction",b)},refresh:function(){k["default"].send({balance:1})["catch"](function(a){i["default"].growl.error({message:a.message})}),y(p).then(z)}});var d=l.parent().find(".ui-dialog-title").addClass("with-content");n=i["default"]('<span class="span-in-dialog-header" />').insertAfter(d),n.update=function(a){n.html("Account balance: <strong>".i18n()+formatPrice(a,e)+"</strong>")};var e=c.balance.currency;m=i["default"]("<table width='100%' class='portfolio-dialog hover'/>"),m.appendTo(l),m=m.dataTable({data:[],columns:[{title:"Ref.".i18n()},{title:"Contract Details".i18n()},{title:"Purchase".i18n(),render:function(a){return'<span class="bold">'+formatPrice(a,e)+"</span>"}},{title:"Indicative".i18n(),render:function(a){return'<span class="bold">'+formatPrice(a,e)+"</span>"}},{title:""}],rowId:"5",paging:!1,ordering:!1,processing:!0}),m.parent().addClass("hide-search-input"),l.on("click",v),l.track({module_id:"portfolio",is_unique:!0,data:null}),l.dialog("open")})["catch"](function(a){return void 0})},x=function(a){a.forEach(function(a){p.push(a),k["default"].proposal_open_contract.subscribe(a.contract_id)["catch"](function(a){return void 0})})},y=function(a){var b=a.map(function(a){return k["default"].proposal_open_contract.forget(a.contract_id)["catch"](function(a){return i["default"].growl.error({message:a.message})})}),c=_.map(a,"contract_id");return p=p.filter(function(a){return _.includes(c,a.contract_id)===!1}),Promise.all(b)},z=function(){var a=g(h["default"].mark(function b(){var a,c,d,e,f;return h["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return a=i["default"]("#"+m.attr("id")+"_processing").show(),b.prev=1,b.next=4,k["default"].send({portfolio:1});case 4:c=b.sent,d=c.portfolio&&c.portfolio.contracts,e="<button>View</button>".i18n(),f=d.map(function(a){return[a.transaction_id,a.longcode,a.buy_price,"0.00",e,a.contract_id,a]}),d.forEach(function(a){return k["default"].sell_expired(a.expiry_time)}),x(d),m.api().rows().remove(),m.api().rows.add(f),m.api().draw(),a.hide(),b.next=23;break;case 16:b.prev=16,b.t0=b["catch"](1),m.api().rows().remove(),m.api().draw(),a.hide(),i["default"].growl.error({message:b.t0.message});case 23:case"end":return b.stop()}},b,void 0,[[1,16]])}));return function(){return a.apply(this,arguments)}}(),A=a.proposal_open_contract={subscribe:function(){return u("subscribe")},forget:function(){return u("forget")},resubscribe:function(){return u("resubscribe")}};a["default"]={init:q,proposal_open_contract:A}});