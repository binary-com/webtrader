define(["exports","jquery","common/rivetsExtra","lodash","charts/chartWindow","charts/charts","moment","charts/chartingRequestMap","text!charts/chartOptions.html","charts/indicators/indicatorManagement","charts/overlay/overlayManagement","charts/crosshair","charts/chartTemplateManager","css!charts/chartOptions.css","common/util"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";function n(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.getAllChartsWithTheirTypes=a.setIndicatorsCount=a.cleanBinding=a.selectChartType=a.disableEnableCandlestickAndOHLC=a.updateOptions=a.init=void 0;var o=n(b),p=n(c),q=n(d),r=(n(e),n(f)),s=(n(g),n(h)),t=n(i),u=n(j),v=n(k),w=n(l),x=n(m),y=[],z=[],A={},B={},C=!1,D=[{value:"1t",name:"1 Tick",digit:1,type:"ticks"},{value:"1m",name:"1 Minute",digit:1,type:"minutes"},{value:"2m",name:"2 Minutes",digit:2,type:"minutes"},{value:"3m",name:"3 Minutes",digit:3,type:"minutes"},{value:"5m",name:"5 Minutes",digit:5,type:"minutes"},{value:"10m",name:"10 Minutes",digit:10,type:"minutes"},{value:"15m",name:"15 Minutes",digit:15,type:"minutes"},{value:"30m",name:"30 Minutes",digit:30,type:"minutes"},{value:"1h",name:"1 Hour",digit:1,type:"hours"},{value:"2h",name:"2 Hours",digit:2,type:"hours"},{value:"4h",name:"4 Hours",digit:4,type:"hours"},{value:"8h",name:"8 Hours",digit:8,type:"hours"},{value:"1d",name:"1 Day",digit:1,type:"days"}],E=[{value:"candlestick",name:"Candles"},{value:"ohlc",name:"OHLC"},{value:"line",name:"Line"},{value:"dot",name:"Dot"},{value:"linedot",name:"Line Dot"},{value:"spline",name:"Spline"},{value:"table",name:"Table"}],F=(local_storage.get("i18n")||{value:"en"}).value,G=getAppURL(),H=G+"?affiliates=true&instrument={0}&timePeriod={1}&lang="+F,I='<iframe src="'+H+'" width="350" height="400" style="overflow-y : hidden;" scrolling="no" />',J="https://twitter.com/share?url={0}&text={1}",K="https://facebook.com/sharer/sharer.php?u={0}",L="https://plus.google.com/share?url={0}",M="https://www.blogger.com/blog-this.g?u={0}&n={1}",N="http://vk.com/share.php?url={0}&title={1}",O=function(a){a.showTimePeriodSelector=!1,a.toggleLoadSaveSelector(null,a),a.toggleChartTypeSelector(null,a),a.toggleDrawingToolSelector(null,a),a.toggleExportSelector(null,a)},P=function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;"table"==b?(y[a.newTabId].showChartTypeSelector=!1,a.tableViewCallback&&a.tableViewCallback()):(y[a.newTabId].chartType=E.filter(function(a){return a.value==b})[0],y[a.newTabId].showChartTypeSelector=!1,r["default"].refresh("#"+a.newTabId+"_chart",c,b),o["default"]("#"+a.newTabId).trigger("chart-type-changed",b)),O(a)},Q=function(a){var b=!1,c=o["default"](a).highcharts();return c&&c.series.forEach(function(a){"percent"===a.options.compare&&(b=!0)}),b},R=function(a,b){b?(y[a].chartTypes=E,y[a].chartTypes[1].showBorder=!0):y[a].chartTypes=E.filter(function(a){return"candlestick"!==a.value&&"ohlc"!==a.value})},S=function(a,b){var c=b.find(".loadSaveOverlay"),d=b.find(".exportOverlay"),e=b.find(".timeperiod"),f=b.find(".chart_type");b.find(".chartTypeOverlay").css("width",B.ct+53+"px");var g=b.find(".shareButton"),h=420+(B.tp.max+B.ct+65-184);isAffiliates()&&(o["default"](window).width()>h+B.inst?(o["default"](o["default"]("#"+a.newTabId+" .chartOptions .table")[0]).css("margin","5px 0px"),o["default"](o["default"]("#"+a.newTabId+" .chartOptions .table")[0]).css("float","left"),o["default"]("#"+a.newTabId+" .chartOptions .instrument_name"),a.showInstrumentName=!0,o["default"]("#"+a.newTabId+"_chart").highcharts().setTitle({text:""})):(o["default"](o["default"]("#"+a.newTabId+" .chartOptions .table")[0]).css("margin","5px auto"),o["default"](o["default"]("#"+a.newTabId+" .chartOptions .table")[0]).css("float",""),a.showInstrumentName=!1,o["default"]("#"+a.newTabId+"_chart").highcharts().setTitle({text:a.instrumentName}))),b.width()>h?(a.showChartTypeLabel=!0,a.timePeriod_name=a.timePeriod.name,e.css("width",B.tp.max+25+"px"),f.css("width",B.ct+55+"px")):(a.showChartTypeLabel=!1,a.timePeriod_name="en"==F?a.timePeriod.value.toUpperCase():a.timePeriod.value.i18n(),e.css("width",B.tp.min+27+"px"),f.css("width","45px"));var i=b.width()-(g.offset().left+g.outerWidth()-b.offset().left);b.width()<=730?(i=i>0?i:25,d.css("right",i+"px"),c.css("right",i+35+"px")):(c.css("right","auto"),d.css("right","auto"))},T=function(a){var b=D.reduce(function(a,b){return a.value.i18n().length>b.value.i18n().length?a:b}),c=D.reduce(function(a,b){return a.name.i18n().length>b.name.i18n().length?a:b}),d=E.reduce(function(a,b){return a.name.i18n().length>b.name.i18n().length?a:b}),e=function(a){var b="0.8em roboto,sans-serif",c=o["default"]("<div>"+a.i18n()+"</div>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden",font:b}).appendTo(o["default"]("body")),d=c.width();return c.remove(),d};B.tp={},B.tp.min=e(b.value),B.tp.max=e(c.name),B.ct=e(d.name),B.inst=e(a)+20},U=function(a,b){a=o["default"](a);var c=a.attr("class");a.toggleClass(c);var d=c.split("-")[0];c=b===!0?d+"-w-icon":d+"-icon",a.toggleClass(c)},V=a.init=function(a,b,c,d,e,f,g,h){T(e),z[a]&&z[a].unbind(),y[a]={newTabId:a,timePeriod:D.filter(function(a){return b==a.value})[0],timeperiod_arr:D,chartType:E.filter(function(a){return a.value==c})[0],tableViewCallback:d,instrumentName:e,instrumentCode:f,indicatorsCount:0,overlayCount:0,showTimePeriodSelector:!1,showChartTypeSelector:!1,showTableOption:!0,enableCrosshair:!0,showDrawingToolSelector:!1,showExportSelector:!1,showLoadSaveSelector:!1,showShare:"undefined"==typeof g?!0:g,showOverlay:"undefined"==typeof h?!0:h,showInstrumentName:!1,exportChartURLShare:H.format(f,b),exportChartIframeShare:I.format(f,b),fbShareLink:K.format(encodeURIComponent(H.format(f,b))),twitterShareLink:J.format(encodeURIComponent(H.format(f,b)),e+"("+b+")"),gPlusShareLink:L.format(encodeURIComponent(H.format(f,b))),bloggerShareLink:M.format(H.format(f,b),e+"("+b+")"),vkShareLink:N.format(H.format(f,b),e+"("+b+")")},z[a]=null,y[a].toggleTimerPeriodSelector=function(a,b){var c=!b.showTimePeriodSelector;O(b),b.showTimePeriodSelector=c,a.originalEvent.scope=b.newTabId},y[a].toggleChartTypeSelector=function(a,b){var c=!b.showChartTypeSelector,d=o["default"]("#"+b.newTabId+" .chart_type .img span")[0];1==c&&a?(O(b),b.showChartTypeSelector=c,U(d,!0),a.originalEvent.scope=b.newTabId):(b.showChartTypeSelector=!1,U(d,!1))},y[a].addRemoveIndicator=function(a,b){var c=b.instrumentName+" ("+b.timePeriod.value+")";u["default"].openDialog("#"+b.newTabId+"_chart",c)},y[a].addRemoveOverlay=function(a,b){var c=b.instrumentName+" ("+b.timePeriod.value+")";v["default"].openDialog("#"+b.newTabId+"_chart",c)},y[a].changeChartType=function(a,b){var c=o["default"](a.target).attr("data-charttype");c&&P(b,c)},y[a].changeTimePeriod=function(c,d){var g=c.target.dataset.timeperiod;if(g){d=y[d.newTabId],s["default"].unregister(s["default"].keyFor(d.instrumentCode,d.timePeriod.value),"#"+d.newTabId+"_chart"),d.timePeriod=D.filter(function(a){return g==a.value})[0],S(d,o["default"]("#"+d.newTabId).find(".chart-view"));var h=isTick(g);!h||"candlestick"!==d.chartType.value&&"ohlc"!==d.chartType.value?r["default"].refresh("#"+d.newTabId+"_chart",g,d.chartType.value):P(d,"line",g),R(d.newTabId,!h&&!Q("#"+a+"_chart")),d.exportChartURLShare=H.format(d.instrumentCode,g),d.exportChartIframeShare=I.format(d.instrumentCode,g),d.fbShareLink=K.format(encodeURIComponent(H.format(f,b))),d.twitterShareLink=J.format(encodeURIComponent(H.format(f,b)),e+"("+b+")"),d.gPlusShareLink=L.format(encodeURIComponent(H.format(f,b))),d.bloggerShareLink=M.format(encodeURIComponent(H.format(f,b)),e+"("+b+")"),d.vkShareLink=N.format(encodeURIComponent(H.format(f,b)),e+"("+b+")"),o["default"]("#"+d.newTabId).trigger("chart-time-period-changed",g)}},R(a,!isTick(b)&&!Q("#"+a+"_chart")),d||(y[a].showTableOption=!1),y[a].toggleCrosshair=function(a,b){b.enableCrosshair=!b.enableCrosshair,w["default"].toggleCrossHair("#"+b.newTabId+"_chart")},y[a].toggleDrawingToolSelector=function(a,b){var c=!b.showDrawingToolSelector,d=o["default"]("#"+b.newTabId+" .drawButton .img span")[0];1==c&&a?(O(b),b.showDrawingToolSelector=c,U(d,!0),a.originalEvent.scope=b.newTabId):(b.showDrawingToolSelector=!1,U(d,!1))},y[a].addDrawingTool=function(a,b){var c=a.target.dataset.drawingtool;c&&require(["charts/draw/highcharts_custom/"+c],function(a){var c="#"+b.newTabId+"_chart";o["default"](c).highcharts().annotate=!0,a.init(c)})},y[a].toggleExportSelector=function(a,b){var c=!b.showExportSelector,d=o["default"]("#"+b.newTabId+" .shareButton .img span")[0];1==c&&a?(O(b),b.showExportSelector=c,U(d,!0),a.originalEvent.scope=b.newTabId):(b.showExportSelector=!1,U(d,!1))},y[a].toggleLoadSaveSelector=function(a,b){var c=!b.showLoadSaveSelector,d=o["default"]("#"+b.newTabId+" .templateButton .img span")[0];1==c&&a?(O(b),b.showLoadSaveSelector=c,U(d,!0),a.originalEvent.scope=b.newTabId):(b.showLoadSaveSelector=!1,U(d,!1))},y[a]["export"]=function(a,b){var c=a.target.dataset.exporttype;if(c){var d="#"+b.newTabId+"_chart",e=o["default"](d).highcharts();switch(c){case"png":e.exportChartLocal();break;case"pdf":e.exportChart({type:"application/pdf"});break;case"csv":r["default"].generate_csv(e,o["default"](d).data());break;case"svg":e.exportChartLocal({type:"image/svg+xml"})}}},o["default"]("#"+a).on("chart-indicators-changed",function(b,c){y[a].indicatorsCount=c.get_indicators().length}),y[a].overlayCount=o["default"]("#"+a+"_chart").data("overlayCount"),o["default"]("#"+a).on("chart-overlay-add",function(){var b=o["default"]("#"+a+"_chart").highcharts();y[a].overlayCount=b.get_overlay_count()}),o["default"]("#"+a).on("chart-overlay-remove",function(){var b=o["default"]("#"+a+"_chart").highcharts();y[a].overlayCount=b.get_overlay_count()}),isAffiliates()?o["default"](window).resize(function(){S(y[a],o["default"]("#"+a).find(".chart-view"))}):o["default"]("#"+a).on("resize-event",function(){S(y[a],o["default"](this).find(".chart-view"))}),!C&&o["default"]("body").on("click",function(a){q["default"].forEach(Object.keys(y),function(b){a.originalEvent&&b!=a.originalEvent.scope&&O(y[b])})}),C=!0;var i=o["default"](t["default"]).i18n();o["default"]("#"+a+"_header").prepend(i),p["default"].formatters.filter=function(a,b){return a.filter(function(a){return a.type==b})},z[a]=p["default"].bind(i[0],y[a]);var j=i.find(".chart-template-manager-root");A[a]=x["default"].init(j,a),i.find(".loadSaveOverlay").on("click",function(a){a.stopPropagation()}),i.find(".exportOverlay").on("click",function(a){a.stopPropagation()}),S(y[a],o["default"]("#"+a).find(".chart-view"))},W=a.updateOptions=function(a,b,c,d,e){var f=y[a];f&&(f.chartType=E.filter(function(a){return a.value==b})[0],f.timePeriod=D.filter(function(a){return c==a.value})[0],f.indicatorsCount=d,f.overlayCount=e,R(a,!isTick(c)&&e>0),S(f,o["default"]("#"+a).find(".chart-view")))},X=a.disableEnableCandlestickAndOHLC=function(a,b){y[a]&&R(a,b)},Y=a.selectChartType=function(a,b,c){c?y[a].changeChartType(y[a],b):y[a].chartType=E.filter(function(a){return a.value==b})[0]},Z=a.cleanBinding=function(a){z[a]&&(z[a].unbind(),A[a]&&A[a].unbind(),delete A[a],delete z[a],delete y[a])},$=a.setIndicatorsCount=function(a,b){y[b].indicatorsCount=a},_=a.getAllChartsWithTheirTypes=function(){return q["default"].keys(y).map(function(a){return{id:a,chartType:y[a].chartType.value}})};a["default"]={init:V,updateOptions:W,disableEnableCandlestickAndOHLC:X,selectChartType:Y,cleanBinding:Z,setIndicatorsCount:$,getAllChartsWithTheirTypes:_}});