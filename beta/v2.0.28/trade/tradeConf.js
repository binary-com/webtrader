define(["lodash","jquery","moment","websockets/binary_websockets","common/rivetsExtra","charts/chartingRequestMap","text!trade/tradeConf.html","css!trade/tradeConf.css"],function(a,b,c,d,e,f,g){function h(a,b){if(a+="",!a){var c=f.keyFor(b,0),d=0;return k.chain().find({instrumentCdAndTp:c}).simplesort("time",!0).limit(10).data().forEach(function(a){var b=a.close+"",c=b.substring(b.indexOf(".")+1).length;c>d&&(d=c)}),d}return a.substring(a.indexOf(".")+1).length}function i(b,e){function g(f){if(-1===a.findIndex(b.ticks.array,function(a){return a.epoch===f.time/1e3})&&i>0){var g=h(e.pip,j);b.ticks.array.push({quote:f.close,epoch:f.time/1e3|0,number:b.ticks.array.length+1,tooltip:c.utc(f.time).format("dddd, MMM D, HH:mm:ss")+"<br/>"+e.symbol_name+" "+f.close,decimal_digits:g}),--i}0===i&&(b.ticks.update_status(),b.buy.update(),b.back.visible=!0,d.events.off("tick",l)),"Digits"!==b.ticks.category&&b.ticks.update_status()}var i=1*e.tick_count,j=e.symbol,l=(1*b.buy.purchase_time,null);a.defer(function(){l=d.events.on("tick",function(a){if(a.tick.symbol==j){var c=f.keyFor(a.tick.symbol,0),d=1e3*b.buy.start_time;k.chain().find({$and:[{time:{$gt:d}},{instrumentCdAndTp:c}]}).simplesort("time",!0).limit(5).data().sort(function(a,b){return a.time-b.time}).forEach(g)}})})}function j(c,d,f,j){var k=b(g),l=c.buy,m={title:{text:"Contract Confirmation"},buy:{message:l.longcode,balance_after:l.balance_after,buy_price:l.buy_price,purchase_time:l.purchase_time,start_time:l.start_time,transaction_id:l.transaction_id,payout:l.payout,currency:d.currency,potential_profit:l.payout-l.buy_price,potential_profit_text:"Profit",show_result:!1},spreads:{amount_per_point:l.amount_per_point||"0",stop_loss_level:l.stop_loss_level||"0",stop_profit_level:l.stop_profit_level||"0"},ticks:{array:[],average:function(){for(var a=this.array,b=0,c=0;c<a.length;++c)b+=1*a[c].quote;var d=b/(a.length||1);return d},getPlotX:function(){var a=this.array.length;return 1===a?{value:a,label:"Entry Spot"}:a===this.tick_count?{value:a,label:"Exit Spot"}:null},getPlotY:function(){var a=this.array.length,b=this.array[a-1];if("Up/Down"===this.category&&1===a)return{value:1*b.quote,label:"Barrier ("+b.quote+")",id:"plot-barrier-y"};if("Asians"===this.category){var c=this.average().toFixed(5);return{value:c,label:"Average ("+c+")",id:"plot-barrier-y"}}return null},tick_count:d.tick_count,value:(d.digits_value||"0")+"",category:d.category,category_display:d.category_display,status:"waiting",chart_visible:d.show_tick_chart},arrow:{visible:!d.show_tick_chart&&"Digits"!==d.category},back:{visible:!1}};m.buy.update=function(){var a=m.ticks.status;m.title.text={waiting:"Contract Confirmation",won:"This contract won",lost:"This contract lost"}[a],"lost"===a&&(m.buy.potential_profit=-m.buy.buy_price,m.buy.payout=0,m.buy.potential_profit_text="Lost"),"won"===a&&(m.buy.balance_after=1*l.balance_after+1*m.buy.payout),m.buy.show_result=!0},m.ticks.update_status=function(){var b=h(d.pip,d.symbol),c=a.head(m.ticks.array).quote.toFixed(b)+"",e=a.last(m.ticks.array).quote.toFixed(b)+"",f=m.ticks.value+"",g=m.ticks.average().toFixed(5),i=m.ticks.category,j=m.ticks.category_display,k={Digits:{matches:a.last(e)===f,differs:a.last(e)!==f,over:1*a.last(e)>1*f,under:1*a.last(e)<1*f,odd:1*a.last(e)%2===1,even:1*a.last(e)%2===0},"Up/Down":{rise:1*e>1*c,fall:1*c>1*e},Asians:{"asian up":1*e>g,"asian down":g>1*e}};m.ticks.status=k[i][j]?"won":"lost"},m.back.onclick=function(){j(k)},m.arrow.onclick=function(a){var c=b(a.target);c.addClass("disabled"),require(["viewtransaction/viewTransaction"],function(a){a.init(d.contract_id,d.transaction_id).then(function(){c.removeClass("disabled")})})},m.arrow.visible?m.back.visible=!0:i(m,d);e.bind(k[0],m);f(k)}require(["websockets/stream_handler"]);var k=f.barsTable;return e.binders["tick-chart"]={priority:65,bind:function(a){var b=this.model;a.chart=new Highcharts.Chart({title:"",credits:{enabled:!1},chart:{type:"line",renderTo:a,backgroundColor:null,width:1*(a.getAttribute("width")||350),height:1*(a.getAttribute("height")||120)},tooltip:{formatter:function(){var a=b.array[this.x-1];return a&&a.tooltip||!1}},xAxis:{type:"linear",min:1,max:1*a.getAttribute("tick-count")+1,labels:{enabled:!1}},yAxis:{labels:{align:"left",x:0},title:"",gridLineWidth:0},series:[{data:[]}],exporting:{enabled:!1,enableImages:!1},legend:{enabled:!1}})},routine:function(b,c){var d=this.model,e=function(a,b){a.xAxis[0].addPlotLine({value:b.value,id:b.id||b.value,label:{text:b.label||"label"},color:b.color||"#e98024",width:b.width||2})},f=function(a,b){a.yAxis[0].addPlotLine({id:b.id||b.label,value:b.value,label:{text:b.label,align:"center"},color:"green",width:2})},g=c.length;if(0!=g){var h=a.last(c);b.chart.series[0].addPoint([g,1*h.quote]);var i=d.getPlotX();i&&e(b.chart,i);var j=d.getPlotY();j&&b.chart.yAxis[0].removePlotLine(j.id),j&&f(b.chart,j)}}},{init:j}});