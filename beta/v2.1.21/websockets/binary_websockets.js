define(["jquery","text!oauth/app_id.json","common/util"],function(a,b){function c(){var a=JSON.parse(b),c=local_storage.get("config"),d=c&&c.app_id||"";if(!d){var e=window.location.href;for(var f in a)if(0==e.lastIndexOf(f,0)){d=a[f];break}}return d}var d=!1,e=null,f=c(),g=function(){var b=local_storage.get("config"),c=(local_storage.get("i18n")||{value:"en"}).value,d=(b&&b.websocket_url||"wss://ws.binaryws.com/websockets/v3?l="+c)+"&app_id="+f,e=new WebSocket(d);return e.addEventListener("open",p),e.addEventListener("close",i),e.addEventListener("message",q),e.addEventListener("error",function(){a.growl.error({message:"Connection error.".i18n()}),i()}),e},h=!1,i=function(){require(["windows/tracker"],function(a){var b=a.get_trade_dialogs();d=!1,x("logout"),h||(h=!0,setTimeout(function(){h=!1,e=g(),local_storage.get("oauth")&&C.cached.authorize().then(function(){a.reopen_trade_dialogs(b)}),require(["charts/chartingRequestMap"],function(a){var b=[];Object.keys(a).forEach(function(c){var d=a[c];if(d&&d.symbol&&!d.timerHandler){var e=a.register({symbol:d.symbol,granularity:d.granularity,subscribe:1,count:1,style:d.granularity>0?"candles":"ticks"})["catch"](function(a){});b.push(e)}}),Promise.all(b).then(function(){require(["charts/charts","charts/chartOptions"],function(a,b){b.getAllChartsWithTheirTypes().forEach(function(b){a.refresh("#"+b.id+"_chart",null,b.chartType)})})})})},1e3))})},j={},k=[],l=[],m={},n={},o=function(){return e&&1===e.readyState},p=function(){for(;l.length>0;){var a=l.shift();m[a.req_id]||e.send(JSON.stringify(a))}for(var b in m){var c=m[b];c&&(c.sent_before?c.reject({message:"Connection closed.".i18n()}):(c.sent_before=!0,e.send(JSON.stringify(c.data))))}for(;k.length>0;)k.shift()()},q=function(a){var b=JSON.parse(a.data);(j[b.msg_type]||[]).forEach(function(a){setTimeout(function(){a(b)},0)});var c=b.req_id,d=m[c];d&&(delete m[c],b.error?(b.error.echo_req=b.echo_req,b.error.req_id=b.req_id,d.reject(b.error)):d.resolve(b))};e=g(),require(["websockets/stream_handler"]);var r=function(a){for(var b in{balance:1,statement:1,profit_table:1,portfolio:1,proposal_open_contract:1,buy:1,sell:1,get_self_exclusion:1,set_self_exclusion:1})if(b in a)return!0;return!1},s=0,t=function(a){return a.req_id=++s,new Promise(function(b,c){m[a.req_id]={resolve:b,reject:c,data:a},o()?e.send(JSON.stringify(a)):l.push(a)})},u=function(a){var b=!1,c={authorize:a},e=JSON.stringify(c),f=t(c);return f.then(function(a){d=!0,local_storage.set("authorize",a.authorize);var g=-1!==a.authorize.landing_company_name.indexOf("japan");if(g||x("login",a),local_storage.get("oauth-login")){var h=local_storage.get("oauth-login").value;local_storage.remove("oauth-login"),h&&!g&&x("oauth-login",a)}return b=!0,n[e]={data:c,promise:f},a})["catch"](function(a){throw"SelfExclusion"===a.code||b||(d=!1,x("logout"),local_storage.remove("oauth")),delete n[e],a})},v=function(){local_storage.remove("oauth"),local_storage.remove("authorize"),x("reset_realitycheck"),C.send({logout:1})["catch"](function(b){a.growl.error({message:b.message}),e.close()});for(var b in n)(r(n[b].data)||"authorize"in n[b].data)&&delete n[b]},w=function(a){if(d)return t(a);var b=t.bind(null,a);if(local_storage.get("oauth")){var c=local_storage.get("oauth"),e=c[0].token;return u(e).then(b)}return Promise.reject({message:"Please log in".i18n()})},x=function(a){var b=[].slice.call(arguments,1),c=j[a]||[];c.forEach(function(a){setTimeout(function(){a.apply(void 0,b)},0)})},y=function(a,b){setTimeout(function(){var b=m[a];b&&(delete m[a],b.reject({message:"Timeout for websocket request".i18n()}))},b)},z={},A={},B={},C={events:{on:function(a,b){return(j[a]=j[a]||[]).push(b),b},off:function(a,b){if(j[a]){var c=j[a].indexOf(b);-1!==c&&j[a].splice(c,1)}},on_till:function(a,b){var c=function(){var d=b.apply(this,arguments);d&&C.events.off(a,c)};C.events.on(a,c)}},proposal_open_contract:{subscribe:function(a){if(A[a]&&A[a].subscribers>0)return A[a].subscribers++,A[a].promise;var b=C.send({proposal_open_contract:1,contract_id:a,subscribe:1}).then(function(b){return A[a].stream_id=b.proposal_open_contract.id,b})["catch"](function(b){throw A[a]=void 0,b});return A[a]={subscribers:1,promise:b},b},forget:function(a){var b=A[a],c=B[a];if(!b)return c||Promise.resolve();if(0==b.subscribers)return c;if(b.subscribers--,b.subscribers>0)return Promise.resolve();var d=function(){return A[a]=void 0,C.send({forget:b.stream_id})["catch"](function(b){throw B[a]=void 0,b}).then(function(b){return B[a]=void 0,b})};return B[a]=b.stream_id?d():b.promise["catch"](function(){}).then(function(){return b.stream_id?d():void 0}),B[a]}},execute:function(a){o()?setTimeout(a,0):k.push(a)},invalidate:v,switch_account:function(a){var b=local_storage.get("oauth");if(!b)return Promise.reject({message:"Account token not found.".i18n()});var c=b.map(function(a){return a.id}).indexOf(a);if(-1===c)return promise.reject({message:"Account id not found.".i18n()});var e=b[c];b.splice(c,1),b.unshift(e),local_storage.set("oauth",b);for(var f in n)(r(n[f].data)||"authorize"in n[f].data)&&delete n[f];return d=!1,C.send({forget_all:"transaction"})["catch"](function(a){}),C.send({forget_all:"balance"})["catch"](function(a){}),C.cached.authorize().then(function(){x("switch_account")})},cached:{send:function(a){var b=JSON.stringify(a);return n[b]?n[b].promise:(n[b]={data:a,promise:null},n[b].promise=C.send(a).then(function(a){return a},function(a){throw delete n[b],a}))},authorize:function(){var a=local_storage.get("oauth"),b=a&&a[0]&&a[0].token,c=JSON.stringify({authorize:b});return d&&b&&n[c]?n[c].promise:b?u(b):Promise.reject("Please log in.".i18n())}},send:function(a,b){if(a&&r(a))return w(a);var c=t(a);return b&&y(a.req_id,b),c},is_authenticated:function(){return d},sell_expired:function(a){var b=(new Date).getTime()/1e3|0;a=a||b+1,!z[a]&&1*a>b&&(z[a]=setTimeout(function(){z[a]=void 0,C.send({sell_expired:1})["catch"](function(a){})},1e3*(a+2-b)))},app_id:f};return C.events.on("login",function(){C.send({transaction:1,subscribe:1})["catch"](function(a){}),C.send({balance:1,subscribe:1})["catch"](function(a){})}),C.events.on("logout",function(){C.send({forget_all:"transaction"})["catch"](function(a){}),C.send({forget_all:"balance"})["catch"](function(a){})}),C});