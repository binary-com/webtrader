define(["jquery"],function(a){var b=!1,c=null,d=function(){var b="wss://ws.binaryws.com/websockets/v3?l=EN",c=new WebSocket(b);return c.addEventListener("open",l),c.addEventListener("close",e),c.addEventListener("message",m),c.addEventListener("error",function(b){a(document).trigger("feedTypeNotification",["websocket-error","noconnection-feed"]),a.growl.error({message:"Connection error. Refresh page!"})}),c},e=function(){b=!1,t("logout"),setTimeout(function(){c=d(),localStorage.getItem("oauth")&&w.cached.authorize(),require(["charts/chartingRequestMap"],function(a){Object.keys(a).forEach(function(b){var c=a[b];c&&c.symbol&&!c.timerHandler&&a.register({symbol:c.symbol,granularity:c.granularity,subscribe:1,count:1,style:c.granularity>0?"candles":"ticks"})["catch"](function(a){})})})},1e3)},f={},g=[],h=[],i={},j={},k=function(){return c&&1===c.readyState},l=function(){for(;h.length>0;){var a=h.shift();i[a.req_id]||c.send(JSON.stringify(a))}for(var b in i){var d=i[b];d&&(d.sent_before?d.reject({message:"connection closed"}):(d.sent_before=!0,c.send(JSON.stringify(d.data))))}for(;g.length>0;)g.shift()()},m=function(a){var b=JSON.parse(a.data);(f[b.msg_type]||[]).forEach(function(a){setTimeout(function(){a(b)},0)});var c=b.req_id,d=i[c];d&&(delete i[c],b.error?(b.error.echo_req=b.echo_req,b.error.req_id=b.req_id,d.reject(b.error)):d.resolve(b))};c=d(),require(["websockets/stream_handler"]);var n=function(a){for(var b in{balance:1,statement:1,profit_table:1,portfolio:1,proposal_open_contract:1,buy:1,sell:1,get_self_exclusion:1,set_self_exclusion:1})if(b in a)return!0;return!1},o=0,p=function(a){return a.req_id=++o,new Promise(function(b,d){i[a.req_id]={resolve:b,reject:d,data:a},k()?c.send(JSON.stringify(a)):h.push(a)})},q=function(a){var c=!1,d={authorize:a},e=JSON.stringify(d),f=p(d);return f.then(function(a){return b=!0,t("login",a),localStorage.getItem("oauth-login")&&(localStorage.removeItem("oauth-login"),t("oauth-login",a)),c=!0,j[e]={data:d,promise:f},a})["catch"](function(a){throw c||(b=!1,t("logout"),localStorage.removeItem("oauth")),delete j[e],a})},r=function(){if(b){localStorage.removeItem("oauth"),w.send({logout:1})["catch"](function(b){a.growl.error({message:b.message}),c.close()});for(var d in j)(n(j[d].data)||"authorize"in j[d].data)&&delete j[d]}},s=function(a){if(b)return p(a);var c=p.bind(null,a);if(localStorage.getItem("oauth")){var d=JSON.parse(localStorage.getItem("oauth")),e=d[0].token;return q(e).then(c)}return Promise.reject({message:"Please log in."})},t=function(a){var b=[].slice.call(arguments,1),c=f[a]||[];c.forEach(function(a){setTimeout(function(){a.apply(void 0,b)},0)})},u=function(a,b){setTimeout(function(){var b=i[a];b&&(delete i[a],b.reject({message:"timeout for websocket request"}))},b)},v={},w={events:{on:function(a,b){return(f[a]=f[a]||[]).push(b),b},off:function(a,b){if(f[a]){var c=f[a].indexOf(b);-1!==c&&f[a].splice(c,1)}},on_till:function(a,b){var c=function(){var d=b.apply(this,arguments);d&&w.events.off(a,c)};w.events.on(a,c)}},execute:function(a){k()?setTimeout(a,0):g.push(a)},invalidate:r,switch_account:function(a){if(!b)return Promise.reject({message:"Session is not authenticated."});var c=localStorage.getItem("oauth");if(!c)return promise.reject({message:"Account token not found."});c=JSON.parse(c);var d=c.map(function(a){return a.id}).indexOf(a);if(-1===d)return promise.reject({message:"Account id not found."});var e=c[d];c.splice(d,1),c.unshift(e),localStorage.setItem("oauth",JSON.stringify(c));for(var f in j)(n(j[f].data)||"authorize"in j[f].data)&&delete j[f];return b=!1,w.send({forget_all:"transaction"})["catch"](function(a){}),w.send({forget_all:"balance"})["catch"](function(a){}),w.cached.authorize()},cached:{send:function(a){var b=JSON.stringify(a);return j[b]?j[b].promise:(j[b]={data:a,promise:null},j[b].promise=w.send(a).then(function(a){return a},function(a){throw delete j[b],a}))},authorize:function(){var a=JSON.parse(localStorage.getItem("oauth")),c=a[0].token,d=JSON.stringify({authorize:c});return b&&c&&j[d]?j[d].promise:c?q(c):Promise.reject("Please log in.")}},send:function(a,b){if(a&&n(a))return s(a);var c=p(a);return b&&u(a.req_id,b),c},is_authenticated:function(){return b},sell_expired:function(a){var b=(new Date).getTime()/1e3|0;a=a||b+1,!v[a]&&1*a>b&&(v[a]=setTimeout(function(){v[a]=void 0,w.send({sell_expired:1})["catch"](function(a){})},1e3*(a+2-b)))}};return w.events.on("login",function(){w.send({transaction:1,subscribe:1})["catch"](function(a){}),w.send({balance:1,subscribe:1})["catch"](function(a){})}),w});